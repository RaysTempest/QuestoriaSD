<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questoria - Petualangan Belajar SD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        /* --- Root Variables for Theming --- */
        :root {
            --bg-color: #f0f9ff;
            --text-color: #0c4a6e;
            --card-bg-color: #ffffff;
            --modal-bg-color: #ffffff;
            --border-color: #e0e7ff;
            --header-bg: rgba(255, 255, 255, 0.7);
        }
        /* --- Dark Theme --- */
        body.dark {
            --bg-color: #071022;
            --text-color: #e2e8f0;
            --card-bg-color: #0f172a;
            --modal-bg-color: #1e293b;
            --border-color: #334155;
            --header-bg: rgba(15, 23, 42, 0.85);
        }
         /* --- High Contrast Theme --- */
       body.high-contrast {
           --bg-color: #000000;
           --text-color: #ffff00;
           --card-bg-color: #000000;
           --modal-bg-color: #000000;
           --border-color: #ffff00;
           --header-bg: rgba(0, 0, 0, 0.95);
       }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.5s, color 0.5s;
        }
        .font-brand { font-family: 'Fredoka One', cursive; }
        .screen, .modal-overlay { display: none; }
        .screen.active, .modal-overlay.active { display: flex; }
        .screen.active { animation: fadeIn 0.6s ease forwards; }

        /* Latar Belakang Gradien */
        #app-container {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.dark #app-container {
            background-image: linear-gradient(135deg, #1e3a8a 0%, #4c1d95 100%);
        }
        
        /* Animasi Splash Screen */
        #splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.7s ease-out;
        }
        #splash-logo {
            animation: popIn 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, float 4s ease-in-out 1.2s infinite;
        }
        #splash-text {
            animation: fadeInText 1.5s ease 0.8s forwards;
            opacity: 0;
        }
        #loading-bar-container {
            width: 200px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 2rem;
            overflow: hidden;
            opacity: 0;
            animation: fadeInText 1.5s ease 1s forwards;
        }
        #loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #fb923c);
            border-radius: 2px;
            animation: load 3.5s ease-out forwards;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeInText {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes load {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Gaya Tombol Pilihan Peran */
        .role-option {
            transition: all 0.2s ease-in-out;
        }
        .role-option.selected {
            transform: scale(1.05);
            border-color: #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        }
        
        /* Gaya & Animasi Tambahan dari Versi Ultimate */
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .modal-overlay.active > .modal-content { animation: scaleUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .star-animation { animation: star-pop 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .point-animation { 
            position: fixed; top: 50%; left: 50%; 
            font-size: 2.5rem; font-weight: bold; color: #f59e0b; 
            z-index: 100; pointer-events: none; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: floatUpAndFade 1.5s ease-out forwards;
        }
        .mascot-tip { position: fixed; bottom: 20px; left: 20px; background-color: var(--modal-bg-color); padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; display: flex; align-items: center; max-width: 300px; animation: slideInLeft 0.5s ease-out; }
        .badge-pop { animation: badge-pop 900ms cubic-bezier(.2,.9,.3,1); transform-origin: center; }
        @keyframes badge-pop { 0% { transform: scale(0) rotate(-30deg); opacity: 0; } 60% { transform: scale(1.15) rotate(8deg); opacity: 1; } 100% { transform: scale(1) rotate(0); opacity: 1; } }
        
        @keyframes scaleUp { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes floatUpAndFade { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0; transform: translate(-50%, -250%) scale(1.5); } }
        @keyframes star-pop { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 60% { transform: scale(1.5) rotate(15deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .avatar-selection { cursor: pointer; border: 4px solid transparent; border-radius: 50%; transition: all 0.2s ease; position: relative; }
        .avatar-selection.selected { border-color: #2563eb; transform: scale(1.1); box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); }
        
        /* Quiz feedback flash */
        .quiz-correct { animation: quiz-correct 700ms ease forwards; }
        .quiz-wrong { animation: quiz-wrong 700ms ease forwards; }
        @keyframes quiz-correct { 0% { background-color: transparent; } 50% { background-color: rgba(34,197,94,0.15); transform: scale(1.02); } 100% { background-color: transparent; transform: scale(1); } }
        @keyframes quiz-wrong { 0% { background-color: transparent; } 50% { background-color: rgba(239,68,68,0.12); transform: scale(0.98); } 100% { background-color: transparent; transform: scale(1); } }

        .confetti-piece { position: fixed; width: 10px; height: 14px; opacity: 0.95; z-index: 1000; transform: translateY(0) rotate(0); animation: confetti-fall 1800ms linear forwards; }
        @keyframes confetti-fall { to { transform: translateY(120vh) rotate(720deg); opacity: 0; } }
        
        /* --- [BARU] Gaya untuk Layar Mulai --- */
        #start-screen .content-wrapper {
            position: relative;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            text-align: center;
        }

        .floating-shape {
            position: absolute;
            opacity: 0.5;
            animation: float-around 15s ease-in-out infinite;
            filter: blur(2px);
        }
        .shape1 { top: 10%; left: 15%; width: 80px; height: 80px; animation-duration: 12s; }
        .shape2 { top: 70%; left: 80%; width: 50px; height: 50px; animation-duration: 18s; }
        .shape3 { top: 80%; left: 10%; width: 60px; height: 60px; animation-duration: 14s; }
        .shape4 { top: 20%; left: 75%; width: 40px; height: 40px; animation-duration: 20s; }

        @keyframes float-around {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            50% { transform: translateY(-30px) rotate(180deg) scale(1.1); }
        }

        #start-game-btn {
            animation: pulse-button 2s infinite;
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        #start-game-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }
        @keyframes pulse-button {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(251, 191, 36, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }

        .screen.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

    </style>
</head>
<body>
  <!-- Background music: file placed in background_music/ -->
  <!-- Audio will start only after user presses the 'Mulai' button (user gesture) -->
  <audio id="background-music" loop preload="auto">
    <source src="background_music/Learning Quest Melody.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

    <!-- Small mute/unmute toggle in corner (hidden until music started) -->
  <button id="mute-btn" style="position:fixed;bottom:12px;right:12px;padding:8px 12px;border-radius:6px;border:none;background:#0b79f7;color:#fff;cursor:pointer;z-index:9999;display:none;">Mute</button>
    <!-- small inline start button removed; audio will be started by the big Start button -->

  <!-- Splash Screen -->
    <div id="splash-screen">
        <svg id="splash-logo" width="120" height="120" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#fde047;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="grad2" x1="0%" y1="100%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#38bdf8;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="48" fill="none" stroke="#e0e7ff" stroke-width="4" opacity="0.5"/>
            <path d="M50 10 L60 40 L90 50 L60 60 L50 90 L40 60 L10 50 L40 40 Z" fill="url(#grad1)" transform="rotate(45 50 50)"/>
            <path d="M50 10 L60 40 L90 50 L60 60 L50 90 L40 60 L10 50 L40 40 Z" fill="url(#grad2)"/>
            <circle cx="50" cy="50" r="10" fill="white"/>
        </svg>
        <h1 id="splash-text" class="font-brand text-5xl md:text-6xl text-white mt-6">Questoria</h1>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
    </div>

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden">
        
        <!-- ===== [BARU] Layar Mulai ===== -->
        <div id="start-screen" class="screen flex-col w-full h-full items-center justify-center text-center relative overflow-hidden">
            <!-- Elemen dekoratif yang melayang -->
            <svg class="floating-shape shape1" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 0 L61.2 34.5 L97.5 34.5 L68.1 55.9 L79.4 90.5 L50 69.1 L20.6 90.5 L31.9 55.9 L2.5 34.5 L38.8 34.5 Z" fill="#FBBF24"/></svg>
            <svg class="floating-shape shape2" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#34D399"/></svg>
            <svg class="floating-shape shape3" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="20" fill="#A78BFA" transform="rotate(45 50 50)"/></svg>
            <svg class="floating-shape shape4" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><polygon points="50,0 100,100 0,100" fill="#F472B6"/></svg>
        
            <div class="content-wrapper z-10">
                <div id="start-screen-mascot" class="w-32 h-32 mx-auto mb-4">
                    <!-- Maskot akan dimasukkan di sini oleh JavaScript -->
                </div>
                <h1 class="font-brand text-4xl md:text-5xl text-white mb-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Petualangan Belajar Menantimu!</h1>
                <p class="text-white/80 text-lg mb-8">Tekan mulai untuk masuk</p>
                <button id="start-game-btn" class="w-full max-w-xs bg-amber-400 hover:bg-amber-500 text-sky-900 font-bold py-4 px-8 rounded-full shadow-lg text-2xl">Mulai</button>
            </div>
        </div>

        <!-- ===== SCREENS ===== -->
        <div id="entry-screen" class="screen flex-col w-full max-w-md text-center">
            <h1 class="font-brand text-5xl md:text-7xl text-white mb-2">Selamat Datang di</h1>
            <h1 class="font-brand text-6xl md:text-8xl text-amber-300 mb-8">Questoria</h1>
            <div class="space-y-4 w-full">
                <button id="login-btn" class="w-full bg-white hover:bg-gray-100 text-sky-800 font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 text-xl">Masuk Akun</button>
                <button id="register-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 text-xl">Buat Akun Baru</button>
            </div>
        </div>
        
        <div id="role-screen" class="screen flex-col w-full max-w-lg">
            <div class="p-8 rounded-3xl shadow-2xl w-full text-center bg-white/90 backdrop-blur-sm">
                <h1 class="font-brand text-3xl text-sky-700 mb-6">Pilih Peranmu</h1>
                <div class="mb-6">
                    <h2 class="font-semibold text-xl mb-3 text-gray-700">Masuk sebagai:</h2>
                    <div id="role-selection" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div data-role="siswa" class="role-option p-4 border-2 rounded-xl cursor-pointer bg-white">
                            <span class="text-4xl block mb-2">🎓</span>
                            <span class="font-bold text-lg">Siswa</span>
                        </div>
                        <div data-role="guru" class="role-option p-4 border-2 rounded-xl cursor-pointer bg-white">
                            <span class="text-4xl block mb-2">🧑‍🏫</span>
                            <span class="font-bold text-lg">Guru</span>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-6">Aplikasi ini difokuskan untuk jenjang Sekolah Dasar (SD).</p>
                <div class="mt-8 flex gap-4">
                    <button id="back-to-entry-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl shadow-md transition-transform duration-300">Kembali</button>
                    <button id="continue-to-profile-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform duration-300 disabled:bg-gray-400" disabled>Lanjutkan</button>
                </div>
            </div>
        </div>

        <div id="user-selection-screen" class="screen text-center flex-col w-full max-w-4xl">
            <h1 class="font-brand text-5xl md:text-7xl text-white mb-4">Pilih Profil</h1>
            <p class="text-lg md:text-xl mb-8 text-white/80">Siapa yang akan berpetualang hari ini?</p>
            <div id="user-list-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8"></div>
            <button id="back-from-selection-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 mt-4">Kembali</button>
        </div>

        <div id="name-entry-screen" class="screen flex-col w-full max-w-lg">
            <div class="p-8 rounded-3xl shadow-2xl w-full text-center bg-white/90 backdrop-blur-sm">
                 <h1 class="font-brand text-4xl text-sky-700 mb-2">Buat Profil Baru</h1>
                 <p class="mb-6 text-gray-600">Masukkan nama dan pilih avatarmu!</p>
                 <input type="text" id="player-name-input" placeholder="Contoh: Budi" class="text-center text-2xl p-4 border-2 rounded-xl shadow-inner focus:border-orange-500 focus:ring-orange-500 mb-6 w-full bg-white">
                 <p class="font-semibold mb-4 text-gray-700">Pilih Avatar:</p>
                 <div id="avatar-selection-container" class="flex justify-center gap-4 mb-8"></div>
                 <div class="flex gap-4">
                    <button id="cancel-new-user-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl shadow-md transition-transform duration-300">Batal</button>
                    <button id="create-profile-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform duration-300 disabled:bg-gray-400" disabled>Buat Akun & Mulai</button>
                 </div>
            </div>
        </div>
        
        <div id="map-screen" class="screen w-full max-w-7xl mx-auto flex-col">
            <header class="flex flex-wrap justify-between items-center mb-6 px-4 gap-4 w-full backdrop-blur-sm p-4 rounded-2xl shadow" style="background-color: var(--header-bg)">
                <div class="flex items-center gap-4">
                    <div id="user-avatar-header" class="w-16 h-16 cursor-pointer" title="Ganti Pengguna"></div>
                    <div>
                        <h2 class="font-brand text-2xl md:text-4xl" style="color: var(--text-color);" id="welcome-message"></h2>
                        <div class="flex items-center gap-4">
                            <p class="text-md md:text-lg font-bold text-amber-600" id="points-display"></p>
                             <p class="text-md md:text-lg font-bold text-red-500" id="streak-display" title="Bonus login beruntun!"></p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap justify-center">
                 <button id="shop-hub-btn" class="bg-violet-500 hover:bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🛍️ Toko</button>
                   <button id="daily-mission-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🎯 Misi</button>
                   <button id="leaderboard-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🥇 Peringkat</button>
                   <button id="achievements-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🏆 Prestasi</button>
                   <button id="content-creator-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform hover:scale-105">➕ Kelola Materi</button>
                       <div class="relative">
                           <input id="world-search-input" class="hidden md:inline-block p-2 rounded-lg border-2" placeholder="Cari Dunia..." />
                       </div>
                   <button id="settings-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform hover:scale-105">⚙️</button>
                </div>
            </header>
            <div id="dunia-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 md:gap-8 w-full p-2 overflow-y-auto"></div>
        </div>
        
        <div id="submateri-screen" class="screen w-full max-w-5xl mx-auto flex-col">
             <div class="flex justify-between items-center w-full mb-10">
                <button id="back-to-worlds-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold p-3 rounded-full shadow-lg transform hover:scale-105 transition-transform">&larr;</button>
                <h2 id="submateri-title" class="font-brand text-4xl md:text-5xl text-center text-white"></h2>
                <div></div>
            </div>
             <div id="submateri-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full p-2 overflow-y-auto"></div>
       </div>

       <div id="materi-screen" class="screen w-full max-w-4xl mx-auto p-6 md:p-10 rounded-2xl shadow-2xl flex-col bg-white/90 backdrop-blur-sm">
           <div id="materi-content" class="w-full"></div>
            <div class="text-center mt-8 w-full"><button id="back-to-submateri-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-transform">&larr; Kembali</button></div>
       </div>
    </div>

    <!-- ===== MODALS ===== -->
    <div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-6 shadow-2xl w-full max-w-md rounded-2xl" style="background-color: var(--modal-bg-color);">
            <h3 class="font-brand text-3xl text-sky-800 text-center mb-4">Pengaturan</h3>
            <div class="space-y-3">
                 <div class="flex justify-between items-center p-3 rounded-lg" style="background-color: var(--bg-color);">
                    <label for="sound-toggle" class="font-semibold">Efek Suara</label>
                    <button id="sound-toggle" class="text-2xl">🔊</button>
                </div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background-color: var(--bg-color);">
                    <label for="music-toggle" class="font-semibold">Musik Latar</label>
                    <button id="music-toggle" class="text-2xl">🎵</button>
                </div>
                <span class="block font-semibold">Tema Tampilan</span>
                 <div class="grid grid-cols-2 gap-2" id="theme-selector">
                     <button data-theme="light" class="w-full p-2 border-2 rounded-lg font-semibold">☀️ Terang</button>
                     <button data-theme="dark" class="w-full p-2 border-2 rounded-lg font-semibold">🌙 Gelap</button>
                     <button data-theme="high-contrast" class="col-span-2 w-full p-2 border-2 rounded-lg font-semibold">Kontras Tinggi</button>
                 </div>
                 <button id="change-user-btn" class="w-full text-left p-3 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg font-bold">👤 Ganti Pengguna</button>
                 <button id="reset-progress-btn" class="w-full text-left p-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold">🗑️ Reset Progres</button>
            </div>
            <button id="close-settings-btn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>

    <div id="confirm-reset-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-sm text-center rounded-2xl" style="background-color: var(--modal-bg-color);">
            <h3 class="font-bold text-2xl text-red-700">PERINGATAN!</h3>
            <p class="my-4">Yakin ingin mereset progres untuk <strong id="reset-username-confirm"></strong>? Semua poin akan hilang.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-reset-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">Batal</button>
                <button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full">Ya, Yakin</button>
            </div>
        </div>
    </div>

    <div id="shop-hub-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-2xl rounded-2xl" style="background-color: var(--modal-bg-color);">
            <h3 class="font-brand text-4xl text-violet-600 text-center mb-6">Pusat Perbelanjaan</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div data-shop="tokoAvatar" class="open-shop p-6 bg-rose-100 rounded-2xl cursor-pointer card-hover border-2 border-rose-300">
                    <div class="text-5xl mb-2">👕</div>
                    <h4 class="font-bold text-xl text-rose-800">Toko Avatar</h4>
                    <p class="text-sm text-rose-600">Ganti penampilanmu!</p>
                </div>
                <div data-shop="tokoPeningkatan" class="open-shop p-6 bg-emerald-100 rounded-2xl cursor-pointer card-hover border-2 border-emerald-300">
                    <div class="text-5xl mb-2">🔧</div>
                    <h4 class="font-bold text-xl text-emerald-800">Toko Peningkatan</h4>
                    <p class="text-sm text-emerald-600">Item bantu belajar & kosmetik.</p>
                </div>
                <div data-shop="tokoKoin" class="open-shop p-6 bg-indigo-100 rounded-2xl cursor-pointer card-hover border-2 border-indigo-300">
                    <div class="text-5xl mb-2">💎</div>
                    <h4 class="font-bold text-xl text-indigo-800">Tukar Koin</h4>
                    <p class="text-sm text-indigo-600">Tukarkan poin dengan koin & hadiah.</p>
                </div>
                <div data-shop="tokoBurungHantu" class="open-shop p-6 bg-sky-100 rounded-2xl cursor-pointer card-hover border-2 border-sky-300">
                    <div class="text-5xl mb-2">🦉</div>
                    <h4 class="font-bold text-xl text-sky-800">Toko Burung Hantu</h4>
                    <p class="text-sm text-sky-600">Peralatan spesial & kosmetik langka.</p>
                </div>
            </div>
            <button id="close-shop-hub-btn" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>
    
    <div id="avatar-shop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-3xl rounded-2xl" style="background-color: var(--modal-bg-color);">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-brand text-3xl text-violet-600">👕 Toko Avatar 👕</h3>
                <div class="font-bold text-amber-600 text-xl bg-amber-100 px-4 py-2 rounded-full" id="shop-points-display"></div>
            </div>
            <div id="generic-shop-tabs" class="flex gap-2 mb-4">
                <button data-tab="items" class="px-3 py-2 rounded bg-gray-200">Item</button>
                <button data-tab="info" class="px-3 py-2 rounded bg-gray-100">Info</button>
            </div>
            <div id="avatar-shop-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-80 overflow-y-auto p-4 rounded-lg" style="background-color: var(--bg-color);"></div>
            <div id="shop-footer-info" class="text-sm text-gray-600 mt-4"></div>
            <button id="close-avatar-shop-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>

    <!-- Generic Shop Modal -->
    <div id="generic-shop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-6 shadow-2xl w-full max-w-4xl rounded-2xl" style="background-color: var(--modal-bg-color);">
            <div class="flex justify-between items-center mb-4">
                <h3 id="generic-shop-title" class="font-brand text-3xl text-sky-800">Toko</h3>
                <div id="generic-shop-balance" class="font-bold text-amber-600 text-lg"></div>
            </div>
            <div id="generic-shop-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-2 rounded-lg" style="background-color: var(--bg-color);"></div>
            <div class="mt-4 flex gap-2"><button id="generic-shop-close" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Tutup</button></div>
        </div>
    </div>

    <div id="daily-bonus-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-sm text-center rounded-2xl" style="background-color: var(--modal-bg-color);">
            <h3 class="font-brand text-3xl text-yellow-500">Bonus Login Harian!</h3>
            <div class="text-7xl my-4 animate-bounce">💰</div>
            <p class="text-lg mb-2">Kamu mendapatkan <strong class="text-amber-600" id="daily-bonus-amount">50 Poin</strong>!</p>
            <p class="text-lg mb-4" id="daily-streak-bonus-text"></p>
            <button id="close-daily-bonus-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full w-full">Asyik!</button>
        </div>
    </div>

    <div id="achievements-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-lg rounded-2xl" style="background-color: var(--modal-bg-color);">
             <h3 class="font-brand text-3xl text-amber-600 text-center">🏆 Prestasiku 🏆</h3>
            <div id="achievements-list" class="grid max-h-80 overflow-y-auto mt-4 p-1 gap-3"></div>
            <button id="close-achievements-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-lg rounded-2xl" style="background-color: var(--modal-bg-color);">
            <h3 class="font-brand text-3xl text-yellow-600 text-center mb-4">🥇 Papan Peringkat 🥇</h3>
            <div id="leaderboard-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
            <button id="close-leaderboard-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>
    
    <div id="daily-mission-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-md text-center rounded-2xl" style="background-color: var(--modal-bg-color);">
            <h3 class="font-brand text-3xl text-cyan-600 text-center mb-4">🎯 Misi Harian 🎯</h3>
            <p id="daily-mission-text" class="text-lg my-4"></p>
            <div class="w-full bg-gray-200 rounded-full h-6 my-4">
                <div id="mission-progress-bar" class="bg-cyan-500 h-6 rounded-full text-white flex items-center justify-center text-sm font-bold" style="width: 0%;">0%</div>
            </div>
            <button id="claim-mission-reward-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full w-full disabled:bg-gray-400">Klaim Hadiah</button>
            <button id="close-daily-mission-btn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>

    <div id="fun-fact-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content p-8 shadow-2xl w-full max-w-md text-center rounded-2xl" style="background-color: var(--modal-bg-color);">
            <div id="mascot-container" class="w-24 h-24 mx-auto mb-4"></div>
            <h3 class="font-brand text-2xl text-sky-700">Fakta Seru!</h3>
            <p id="fun-fact-text" class="my-4"></p>
            <button id="close-fun-fact-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-lg">Lanjut!</button>
        </div>
    </div>

    <!-- Modal Guru -->
    <div id="content-creator-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content p-6 shadow-2xl w-full max-w-3xl rounded-2xl h-[90vh] overflow-y-auto" style="background-color: var(--modal-bg-color);">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="font-brand text-3xl text-green-700">Buat & Kelola Materi</h3>
                 <button id="close-creator-btn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
           
            <form id="content-creator-form" class="space-y-4">
                <div id="creator-existing" class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-lg mb-2 text-sky-700">Edit Submateri yang Ada</h4>
                    <p class="text-sm text-gray-600 mb-2">Pilih dunia di bawah, lalu pilih submateri untuk diedit atau dihapus.</p>
                    <div id="existing-list" class="max-h-40 overflow-y-auto grid grid-cols-1 gap-2"></div>
                </div>
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-lg mb-2 text-sky-700">1. Pilih atau Buat Dunia Baru</h4>
                    <select id="dunia-select" class="mt-1 block w-full p-2 border rounded-md mb-3"></select>
                    <p class="text-center my-2 font-semibold text-gray-500">ATAU</p>
                    <div class="space-y-2">
                        <input type="text" id="dunia-nama" placeholder="Nama Dunia Baru" class="w-full p-2 border rounded">
                        <input type="text" id="dunia-deskripsi" placeholder="Deskripsi singkat" class="w-full p-2 border rounded">
                        <div class="flex gap-2">
                            <input type="text" id="dunia-warna" placeholder="Warna Tema (e.g., blue)" class="w-1/2 p-2 border rounded">
                            <input type="text" id="dunia-icon" placeholder="Ikon Emoji (e.g., 🔢)" class="w-1/2 p-2 border rounded">
                        </div>
                    </div>
                </div>
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-lg mb-2 text-sky-700">2. Tambah Submateri</h4>
                    <div class="space-y-2">
                        <input type="text" id="submateri-judul" placeholder="Judul Submateri" class="w-full p-2 border rounded" required>
                        <textarea id="submateri-konten" rows="4" placeholder="Isi materi (HTML didukung)" class="w-full p-2 border rounded" required></textarea>
                        <input type="text" id="submateri-funfact" placeholder="Fakta Menarik (opsional)" class="w-full p-2 border rounded">
                    </div>
                </div>
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-lg mb-2 text-sky-700">3. Buat Kuis</h4>
                    <div class="space-y-2">
                        <!-- multi-kuis container will be injected here -->
                        <div id="kuis-multi-container-area"></div>
                    </div>
                </div>
                 <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Simpan Materi</button>
            </form>
        </div>
    </div>

    <!-- Container untuk animasi -->
    <div id="animation-container" class="pointer-events-none"></div>
    <div id="mascot-tip-container"></div>


    <script>
        // --- DATA APLIKASI ---
        // --- AUDIO HELPERS (playlist start, fade-in, mute) ---
        (function(){
            const audioEl = document.getElementById('background-music');
            const muteBtn = document.getElementById('mute-btn');

            // Playlist (order matters) - uses files in /background_music
            const playlist = [
                'background_music/Learning Quest Melody.mp3',
                'background_music/The Learning Quest.mp3'
            ];
            let currentIndex = 0;
            let fadeTimer = null;

            function fadeInAudio(targetVolume = 0.8, duration = 1200) {
                try {
                    if (!audioEl) return;
                    audioEl.volume = 0;
                    audioEl.muted = false;
                    const steps = 30;
                    const stepTime = Math.max(10, Math.floor(duration / steps));
                    let step = 0;
                    if (fadeTimer) clearInterval(fadeTimer);
                    fadeTimer = setInterval(() => {
                        step++;
                        audioEl.volume = Math.min(targetVolume, (targetVolume * step) / steps);
                        if (step >= steps) { clearInterval(fadeTimer); fadeTimer = null; }
                    }, stepTime);
                } catch(e) { console.warn('fadeInAudio error', e); }
            }

            function setTrack(index) {
                if (!audioEl) return;
                currentIndex = index % playlist.length;
                // update src and load
                try {
                    audioEl.src = playlist[currentIndex];
                    audioEl.load();
                } catch(e) { console.warn('setTrack error', e); }
            }

            // play current track (called within user gesture)
            window.startBackgroundMusic = function(){
                if (!audioEl) return;
                // ensure track is set
                setTrack(currentIndex);
                audioEl.loop = false; // we handle playlist looping
                audioEl.play().then(()=>{
                    fadeInAudio(0.8, 800);
                    if (muteBtn) { muteBtn.style.display = 'inline-block'; muteBtn.textContent = audioEl.muted ? 'Unmute' : 'Mute'; }
                }).catch(err => console.warn('background music play failed:', err));
            };

            // When a track ends, advance to next and play (with fade)
            if (audioEl) {
                audioEl.addEventListener('ended', () => {
                    currentIndex = (currentIndex + 1) % playlist.length;
                    setTrack(currentIndex);
                    // small delay to ensure load
                    setTimeout(() => {
                        audioEl.play().then(()=> fadeInAudio(0.8, 700)).catch(()=>{});
                    }, 150);
                });
            }

            // mute toggle safe binding
            if (muteBtn) {
                muteBtn.addEventListener('click', () => {
                    try {
                        audioEl.muted = !audioEl.muted;
                        muteBtn.textContent = audioEl.muted ? 'Unmute' : 'Mute';
                    } catch(e) {}
                });
            }

            // Initialize src to first track (do not autoplay)
            try { setTrack(0); } catch(e){}
        })();
        const avatarData = {
            'avatar1': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#FFFFFF" rx="72"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#75d475"></rect><rect x="0" y="0" width="36" height="36" transform="translate(4 4) rotate(268 18 18) scale(1.2)" fill="#248038" rx="36"></rect><g transform="translate(-4 -1) rotate(8 18 18)"><path d="M15 21c2 1 4 1 6 0" stroke="#000000" fill="none" stroke-linecap="round"></path><rect x="10" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect><rect x="24" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect></g></g></svg>`, isStarter: true },
            'avatar2': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#FFFFFF" rx="72"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#84b6e0"></rect><rect x="0" y="0" width="36" height="36" transform="translate(0 0) rotate(329 18 18) scale(1.2)" fill="#25648a" rx="36"></rect><g transform="translate(0 5) rotate(-9 18 18)"><path d="M15 21c2 1 4 1 6 0" stroke="#FFFFFF" fill="none" stroke-linecap="round"></path><rect x="14" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect><rect x="20" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect></g></g></svg>`, isStarter: true },
            'avatar3': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#f0c38e"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#f0c38e"></rect><rect x="0" y="0" width="36" height="36" transform="translate(8 -6) rotate(114 18 18) scale(1.2)" fill="#a07d58" rx="36"></rect><g transform="translate(4 -4) rotate(-4 18 18)"><path d="M13,21 a8,8 0 0,0 10,0" fill="#000000"></path><rect x="14" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect><rect x="20" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect></g></g></svg>`, isStarter: true },
            'avatar4': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#FFFFFF" rx="72"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#e0a3a3"></rect><rect x="0" y="0" width="36" height="36" transform="translate(-4 -4) rotate(278 18 18) scale(1.1)" fill="#9c5656" rx="64"></rect><g transform="translate(-4 0) rotate(8 18 18)"><path d="M15 19c2 1 4 1 6 0" stroke="#FFFFFF" fill="none" stroke-linecap="round"></path><rect x="11" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect><rect x="23" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect></g></g></svg>`, price: 100 },
            'avatar5': { name: "Kucing Lucu", svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="mask0_33_33" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><circle cx="18" cy="18" r="18" fill="#D9D9D9"/></mask><g mask="url(#mask0_33_33)"><rect width="36" height="36" fill="#F2D4A7"/><ellipse cx="18" cy="33.5" rx="18" ry="13.5" fill="#3B2219"/><path d="M-5 13C-5 5.8203 0.8203 -1.13379e-06 8 -1.13379e-06V13H-5Z" fill="#6A463A"/><path d="M41 13C41 5.8203 35.1797 -1.13379e-06 28 -1.13379e-06V13H41Z" fill="#6A463A"/><rect x="11" y="16" width="3" height="4" rx="1.5" fill="white"/><rect x="22" y="16" width="3" height="4" rx="1.5" fill="white"/><path d="M13 23C13 23 15 25 18 25C21 25 23 23 23 23" stroke="white" stroke-width="2" stroke-linecap="round"/></g></svg>`, price: 200 },
        };

        const shopData = {
            tokoAvatar: {
                title: "Toko Avatar",
                items: {
                    'avatar4': { name: "Gadis Ceria", price: 100, isStarter: false },
                    'avatar5': { name: "Kucing Lucu", price: 250, isStarter: false, icon: "🐱" },
                    'avatar6': { name: "Anjing Ceria", price: 250, isStarter: false, icon: "🐶" },
                    'avatar7': { name: "Robot Masa Depan", price: 500, isStarter: false, icon: "🤖" },
                }
            }
        };
        // Add two more shops (four shops total)
        shopData.tokoPeningkatan = { title: "Toko Peningkatan", items: {} };
        shopData.tokoKoin = { title: "Tukar Koin", items: {} };
        shopData.tokoBurungHantu = { title: "Toko Burung Hantu", items: {} };
        shopData.tokoBonus = { title: "Toko Bonus", items: {} };
        // Add 3 more shops with 10 items each
        shopData.tokoPeningkatan = { title: "Toko Peningkatan", items: {} };
        shopData.tokoKoin = { title: "Tukar Koin", items: {} };
        // helper to create items
        function addShopItems(shopObj, prefix, emojiBase) {
            for (let i=1;i<=10;i++) {
                const id = `${prefix}_${i}`;
                shopObj.items[id] = { name: `${emojiBase} Item ${i}`, price: 25 * i, desc: `Deskripsi singkat untuk Item ${i}` };
            }
        }
        addShopItems(shopData.tokoPeningkatan, 'boost', '✨');
        addShopItems(shopData.tokoKoin, 'koin', '💠');
        // populate burunghantu and bonus shops with themed items
        addShopItems(shopData.tokoBurungHantu, 'owl', '🦉');
        addShopItems(shopData.tokoBonus, 'bonus', '🎁');

        const mascotSVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><path d="M50,15 C25,15 10,35 10,55 C10,80 25,95 50,95 C75,95 90,80 90,55 C90,35 75,15 50,15 Z" fill="#A0522D"/><path d="M35,45 C40,40 50,40 55,45 C60,50 60,60 55,65 L45,65 C40,60 40,50 35,45 Z" fill="#8B4513" transform="translate(-15, 0)"/><path d="M65,45 C60,40 50,40 45,45 C40,50 40,60 45,65 L55,65 C60,60 60,50 65,45 Z" fill="#8B4513" transform="translate(15, 0)"/><circle cx="32" cy="52" r="18" fill="white"/><circle cx="68" cy="52" r="18" fill="white"/><circle cx="33" cy="53" r="8" fill="black"/><circle cx="67" cy="53" r="8" fill="black"/><path d="M50,65 C55,75 45,75 50,65 L52,70 L48,70 Z" fill="#FFC107"/><path d="M20,15 Q30,5 40,15" stroke="#8B4513" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M80,15 Q70,5 60,15" stroke="#8B4513" stroke-width="4" fill="none" stroke-linecap="round"/></g></svg>`;

        let edukasiData = {
            sd: {
                dunia: {
                    matematika_dasar: { 
                        namaDunia: "Kerajaan Angka", warna: "blue", icon: "🔢", deskripsi: "Jelajahi dunia angka, penjumlahan, dan perkalian yang seru!", 
                        subMateri: { 
                            penjumlahan: { judul: "Berhitung Cepat", konten: "<p>Penjumlahan adalah cara menggabungkan dua angka atau lebih. Contoh: 2 apel ditambah 3 apel menjadi 5 apel.</p>", funFact: "Simbol tambah (+) sudah digunakan selama lebih dari 500 tahun!", kuis: [{ type: "pilihan-ganda", pertanyaan: "7 + 8 = ?", pilihan: ["14", "15", "16", "13"], jawaban: "15", hint:"Hitung maju 8 langkah dari 7." }] },
                            pengurangan: { judul: "Ambil dan Sisakan", konten: "<p>Pengurangan adalah mengambil sejumlah angka dari angka lain. Contoh: Punya 5 kue, dimakan 2, sisa 3 kue.</p>", funFact: "Kata 'selisih' adalah nama lain untuk hasil dari pengurangan.", kuis: [{ type: "pilihan-ganda", pertanyaan: "12 - 5 = ?", pilihan: ["6", "7", "8", "9"], jawaban: "7", hint:"Hitung mundur 5 langkah dari 12." }] },
                            perkalian: { judul: "Lompatan Ajaib", konten: "<p>Perkalian adalah penjumlahan berulang. 3 x 4 sama dengan menjumlahkan 4 sebanyak 3 kali.</p>", funFact: "Tabel perkalian modern pertama kali dibuat oleh matematikawan Skotlandia, John Napier.", kuis: [{ type: "pilihan-ganda", pertanyaan: "6 x 3 = ?", pilihan: ["18", "15", "24", "12"], jawaban: "18", hint:"Jumlahkan 6 sebanyak 3 kali." }] },
                            pembagian: { judul: "Bagi Rata", konten: "<p>Pembagian adalah membagi sama rata. 10 permen dibagi untuk 2 anak, masing-masing dapat 5.</p>", funFact: "Simbol bagi (÷) disebut obelus, yang dalam bahasa Yunani berarti 'tusuk sate'.", kuis: [{ type: "pilihan-ganda", pertanyaan: "15 / 3 = ?", pilihan: ["4", "5", "6", "3"], jawaban: "5", hint:"Berapa kali 3 muat dalam 15?" }] },
                            pecahan: { judul: "Potongan Pizza", konten: "<p>Pecahan adalah bagian dari keseluruhan. 1/2 berarti satu dari dua bagian yang sama besar.</p>", funFact: "Orang Mesir kuno menulis semua pecahan sebagai penjumlahan dari pecahan satuan (pembilang 1).", kuis: [{ type: "pilihan-ganda", pertanyaan: "Setengah dari 8 adalah...", pilihan: ["2", "4", "6", "8"], jawaban: "4", hint:"Sama dengan 8 dibagi 2." }] },
                            ganjil_genap: { judul: "Pasukan Ganjil & Genap", konten: "<p>Bilangan genap bisa berpasangan (2, 4, 6), bilangan ganjil selalu ada yang sendirian (1, 3, 5).</p>", funFact: "Menjumlahkan dua bilangan ganjil selalu menghasilkan bilangan genap.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Manakah yang bilangan ganjil?", pilihan: ["10", "17", "22", "8"], jawaban: "17", hint:"Angka yang tidak bisa dibagi 2." }] },
                            pengukuran: { judul: "Mengukur Dunia", konten: "<p>Kita mengukur panjang dengan sentimeter (cm) dan berat dengan kilogram (kg).</p>", funFact: "Satu kilogram awalnya didefinisikan berdasarkan berat satu liter air.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Alat untuk mengukur panjang buku adalah...", pilihan: ["Timbangan", "Penggaris", "Jam", "Gelas Ukur"], jawaban: "Penggaris", hint:"Ada di kotak pensilmu." }] },
                            bangun_datar_ruang: { judul: "Berburu Bentuk", konten: "<p>Ada bentuk datar (persegi, lingkaran) dan bentuk ruang (kubus, bola).</p>", funFact: "Sarang lebah menggunakan bentuk segienam karena itu cara paling efisien untuk mengisi ruang.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Benda yang bentuknya seperti dadu adalah...", pilihan: ["Bola", "Kubus", "Piramida", "Kerucut"], jawaban: "Kubus", hint:"Memiliki 6 sisi yang sama." }] },
                            waktu: { judul: "Waktu Berpetualang", konten: "<p>Jarum pendek jam menunjuk jam, jarum panjang menunjuk menit.</p>", funFact: "Pembagian jam menjadi 60 menit berasal dari sistem angka bangsa Babilonia kuno.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Jika jarum pendek di angka 3 dan panjang di 12, pukul berapa itu?", pilihan: ["12:03", "03:12", "03:00", "03:30"], jawaban: "03:00", hint:"Angka 12 pada jarum panjang berarti menit ke-0." }] },
                            pola_bilangan: { judul: "Pola Rahasia", konten: "<p>Pola adalah urutan yang berulang dengan aturan. Contoh: 2, 4, 6, 8, ... (ditambah 2).</p>", funFact: "Pola bilangan sering ditemukan di alam, seperti pada kelopak bunga dan cangkang siput.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Lanjutkan pola ini: 5, 10, 15, ...?", pilihan: ["16", "20", "25", "30"], jawaban: "20", hint:"Ini adalah pola ditambah 5." }] }
                        } 
                    },
                    bahasa_indonesia_sd: { 
                        namaDunia: "Pulau Kata", warna: "green", icon: "✍️", deskripsi: "Belajar membaca, menulis, dan menyusun kalimat dengan benar.", 
                        subMateri: {
                            alfabet: { judul: "Pasukan Alfabet", konten: "<p>Alfabet adalah kumpulan huruf dari A sampai Z. Setiap huruf memiliki bunyinya sendiri.</p>", funFact: "Bahasa Indonesia menggunakan 26 huruf alfabet Latin, sama seperti Bahasa Inggris.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Huruf apa yang datang setelah huruf 'G'?", pilihan: ["F", "H", "I", "J"], jawaban: "H", hint:"E, F, G, ..." }] },
                            merangkai_kata: { judul: "Merangkai Kata Ajaib", konten: "<p>Menggabungkan huruf vokal (a, i, u, e, o) dan konsonan akan membentuk kata yang punya arti.</p>", funFact: "Kata terpanjang dalam kamus bahasa Indonesia adalah 'mempertanggungjawabkannya'.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Susun huruf 'k-u-b-u' menjadi nama benda.", pilihan: ["kuub", "buku", "kibu", "ubuk"], jawaban: "buku", hint:"Digunakan untuk membaca." }] },
                            tanda_baca: { judul: "Tuan Tanda Baca", konten: "<p>Tanda baca membantu kita mengerti tulisan. Titik (.) untuk berhenti, koma (,) untuk jeda, dan tanda tanya (?) untuk bertanya.</p>", funFact: "Tanda seru (!) dulunya ditulis sebagai kata Latin 'io' yang berarti 'seruan kegembiraan'.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Tanda baca di akhir kalimat 'Siapa namamu' adalah...", pilihan: [".", ",", "?", "!"], jawaban: "?", hint:"Ini adalah kalimat tanya." }] },
                            kalimat: { judul: "Siapa, Apa, di Mana?", konten: "<p>Kalimat yang baik biasanya menjawab pertanyaan siapa (Subjek), melakukan apa (Predikat), dan apa/siapa yang dikenai (Objek).</p>", funFact: "Tanda titik (.) digunakan untuk mengakhiri sebuah kalimat berita.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Manakah kalimat yang benar?", pilihan: ["Makan nasi saya", "Saya makan nasi", "Nasi saya makan", "Saya nasi makan"], jawaban: "Saya makan nasi", hint:"Urutan S-P-O." }] },
                        }
                    },
                    ipa_sd: { 
                        namaDunia: "Taman Sains", warna: "yellow", icon: "🌿", deskripsi: "Pelajari tentang hewan, tumbuhan, dan alam sekitar kita.",
                        subMateri: {
                            hewan: { judul: "Sahabat Satwa", konten: "<p>Ada banyak jenis hewan di dunia. Ada karnivora (pemakan daging), herbivora (pemakan tumbuhan), dan omnivora (pemakan segala).</p>", funFact: "Gajah adalah satu-satunya mamalia yang tidak bisa melompat!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Sapi adalah contoh hewan pemakan...", pilihan: ["Daging", "Tumbuhan", "Segalanya", "Ikan"], jawaban: "Tumbuhan", hint:"Sapi makan rumput." }] },
                            tumbuhan: { judul: "Akar, Batang, dan Daun", konten: "<p>Tumbuhan memiliki akar untuk menyerap air, batang untuk berdiri tegak, dan daun untuk membuat makanan (fotosintesis).</p>", funFact: "Pohon tertinggi di dunia bisa mencapai ketinggian lebih dari 100 meter!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Bagian tumbuhan yang berfungsi membuat makanan adalah...", pilihan: ["Akar", "Batang", "Daun", "Bunga"], jawaban: "Daun", hint:"Warnanya biasanya hijau." }] },
                            pancaindra: { judul: "Lima Indra Ajaib", konten: "<p>Manusia punya lima indra: mata untuk melihat, telinga untuk mendengar, hidung untuk mencium, lidah untuk mengecap, dan kulit untuk meraba.</p>", funFact: "Hidung manusia bisa membedakan lebih dari 1 triliun bau yang berbeda.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Indra yang digunakan untuk merasakan manisnya gula adalah...", pilihan: ["Mata", "Kulit", "Lidah", "Telinga"], jawaban: "Lidah", hint:"Letaknya di dalam mulut." }] },
                        }
                    },
                    ips_sd: {
                        namaDunia: "Nusantara Kita", warna: "orange", icon: "🗺️", deskripsi: "Kenali keragaman suku, budaya, dan geografi Indonesia.",
                        subMateri: {
                            peta: { judul: "Membaca Peta", konten: "<p>Peta adalah gambar permukaan bumi. Ada simbol-simbol di peta untuk gunung, sungai, dan kota.</p>", funFact: "Peta tertua yang diketahui berasal dari Babilonia sekitar 2.500 tahun yang lalu.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Warna biru pada peta biasanya melambangkan...", pilihan: ["Gunung", "Hutan", "Perairan", "Gurun"], jawaban: "Perairan", hint:"Seperti warna laut dan danau." }] },
                            kenampakan_alam: { judul: "Gunung dan Pantai", konten: "<p>Indonesia punya banyak kenampakan alam seperti gunung berapi, sungai yang panjang, dan pantai yang indah.</p>", funFact: "Indonesia adalah negara dengan jumlah gunung berapi aktif terbanyak di dunia.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Daerah daratan yang menjorok ke laut disebut...", pilihan: ["Teluk", "Tanjung", "Selat", "Delta"], jawaban: "Tanjung", hint:"Kebalikan dari teluk." }] },
                        }
                    },
                }
            }
        };

        const achievementsDefinitions = {
            sd: [
                { id: 'sd_complete_dunia_1', title: 'Penjelajah Mini', desc: 'Selesaikan 1 dunia penuh', condition: (u)=>{ for (const d in edukasiData.sd.dunia){ const total=Object.keys(edukasiData.sd.dunia[d].subMateri).length; const done=Object.values((u.progress.sd||{})[d]||{}).filter(p=>p.done).length; if (done === total && total > 0) return true; } return false; } },
                { id: 'sd_5_submateri', title: 'Pecinta Belajar', desc: 'Selesaikan 5 submateri', condition: (u)=>{ let c=0; for(const d in (u.progress.sd||{})) c += Object.values(u.progress.sd[d]).filter(p=>p.done).length; return c>=5; } },
                { id: 'sd_150_points', title: 'Poin Juara Kelas', desc: 'Kumpulkan 150 poin', condition: (u)=> (u.points||0) >= 150 },
                { id: 'sd_login_3', title: 'Rajin Masuk', desc: 'Masuk 3 hari berturut-turut', condition: (u)=> (u.loginStreak || 0) >= 3 },
            ]
        };

        // Variabel & State Aplikasi
        const domElements = { 
            screens: document.querySelectorAll('.screen'), 
            modals: document.querySelectorAll('.modal-overlay'),
            splashScreen: document.getElementById('splash-screen'),
            entryScreen: document.getElementById('entry-screen'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            roleScreen: document.getElementById('role-screen'),
            userSelectionScreen: document.getElementById('user-selection-screen'),
            nameEntryScreen: document.getElementById('name-entry-screen'),
            userListContainer: document.getElementById('user-list-container'), 
            playerNameInput: document.getElementById('player-name-input'), 
            avatarSelectionContainer: document.getElementById('avatar-selection-container'),
            createProfileBtn: document.getElementById('create-profile-btn'),
            cancelNewUserBtn: document.getElementById('cancel-new-user-btn'), 
            welcomeMessage: document.getElementById('welcome-message'), 
            pointsDisplay: document.getElementById('points-display'), 
            streakDisplay: document.getElementById('streak-display'),
            userAvatarHeader: document.getElementById('user-avatar-header'), 
            duniaContainer: document.getElementById('dunia-container'), 
            submateriContainer: document.getElementById('submateri-container'), 
            submateriTitle: document.getElementById('submateri-title'), 
            materiContent: document.getElementById('materi-content'), 
            backToWorldsBtn: document.getElementById('back-to-worlds-btn'), 
            backToSubmateriBtn: document.getElementById('back-to-submateri-btn'), 
            settingsBtn: document.getElementById('settings-btn'),
            soundToggle: document.getElementById('sound-toggle'),
            musicToggle: document.getElementById('music-toggle'),
            themeSelector: document.getElementById('theme-selector'),
            changeUserBtn: document.getElementById('change-user-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'), 
            resetProgressBtn: document.getElementById('reset-progress-btn'), 
            resetUsernameConfirm: document.getElementById('reset-username-confirm'), 
            cancelResetBtn: document.getElementById('cancel-reset-btn'), 
            confirmResetBtn: document.getElementById('confirm-reset-btn'),
            contentCreatorBtn: document.getElementById('content-creator-btn'),
            contentCreatorModal: document.getElementById('content-creator-modal'),
            closeCreatorBtn: document.getElementById('close-creator-btn'),
            duniaSelect: document.getElementById('dunia-select'),
            shopHubBtn: document.getElementById('shop-hub-btn'),
            dailyMissionBtn: document.getElementById('daily-mission-btn'),
            leaderboardBtn: document.getElementById('leaderboard-btn'),
            achievementsBtn: document.getElementById('achievements-btn'),
            avatarShopContainer: document.getElementById('avatar-shop-container'),
            shopPointsDisplay: document.getElementById('shop-points-display'),
            closeAvatarShopBtn: document.getElementById('close-avatar-shop-btn'),
            dailyBonusAmount: document.getElementById('daily-bonus-amount'),
            dailyStreakBonusText: document.getElementById('daily-streak-bonus-text'),
            achievementsList: document.getElementById('achievements-list'),
            leaderboardList: document.getElementById('leaderboard-list'),
            dailyMissionText: document.getElementById('daily-mission-text'),
            missionProgressBar: document.getElementById('mission-progress-bar'),
            claimMissionRewardBtn: document.getElementById('claim-mission-reward-btn'),
            funFactText: document.getElementById('fun-fact-text'),
            closeFunFactBtn: document.getElementById('close-fun-fact-btn'),
            mascotContainer: document.getElementById('mascot-container'),
            animationContainer: document.getElementById('animation-container'),
            mascotTipContainer: document.getElementById('mascot-tip-container'),
        };

        let userProfiles = [];
        let currentUserIndex = -1;
        let activeUser = null;
        let currentDuniaId = null;
        let currentSubmateriId = null;
        let selectedAvatarId = null;
        let tempUserData = { role: null, jenjang: 'sd' };
        
        const sounds = { 
            click: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(), 
            correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.2 } }).toDestination(), 
            wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.2 } }).toDestination(),
            badge: new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 0.5 } }).toDestination(),
            purchase: new Tone.Synth({ oscillator: { type: "triangle8" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.2 } }).toDestination(),
        };

        const colorMapping = { 
            green: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-400', progress: 'bg-green-500' }, 
            blue: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400', progress: 'bg-blue-500' },
            purple: { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-400', progress: 'bg-purple-500' },
            red: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-400', progress: 'bg-red-500' },
            stone: { bg: 'bg-stone-100', text: 'text-stone-800', border: 'border-stone-400', progress: 'bg-stone-500' },
            yellow: { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-400', progress: 'bg-yellow-500' },
            orange: { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-400', progress: 'bg-orange-500' },
            pink: { bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-400', progress: 'bg-pink-500' },
            teal: { bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-400', progress: 'bg-teal-500' },
            fuchsia: { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800', border: 'border-fuchsia-400', progress: 'bg-fuchsia-500' },
        };
        
        // --- Fungsi-fungsi Aplikasi ---
        function playSound(type) {
            if(!activeUser || !activeUser.settings.soundOn) return;
            try {
                if (Tone.context.state !== 'running') { Tone.start(); }
                if(sounds[type]) sounds[type].triggerAttackRelease(type === 'wrong' ? "C3" : "C4", "8n");
            } catch(e) { console.warn("Audio error:", e); }
        }

        function saveData() { 
            if (currentUserIndex > -1 && activeUser) { 
                userProfiles[currentUserIndex] = activeUser; 
            } 
            localStorage.setItem('questoriaUsersV2', JSON.stringify(userProfiles));
            localStorage.setItem('questoriaEduDataV2', JSON.stringify(edukasiData));
        }

        function loadData() { 
            const users = localStorage.getItem('questoriaUsersV2'); 
            const edu = localStorage.getItem('questoriaEduDataV2');
            if (users) { 
                userProfiles = JSON.parse(users); 
            }
            if (edu) {
                edukasiData = JSON.parse(edu);
            }
            return userProfiles.length > 0;
        }

        function switchScreen(id) { 
            domElements.screens.forEach(s => s.classList.remove('active')); 
            const screen = document.getElementById(id); 
            if (screen) screen.classList.add('active'); 
        }

    function showModal(id) { document.getElementById(id)?.classList.add('active'); }
    function hideModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }

        // Generic shop functions
        function openGenericShop(shopId) {
            if (!activeUser) { showMascotTip('Silakan pilih pengguna terlebih dahulu.'); return; }
            const shop = shopData[shopId];
            if (!shop) return;
            document.getElementById('generic-shop-title').textContent = shop.title;
            document.getElementById('generic-shop-balance').textContent = `Poin: ${activeUser.points}`;
            renderShopItems(shopId);
            showModal('generic-shop-modal');
        }

        function renderShopItems(shopId) {
            const grid = document.getElementById('generic-shop-grid');
            grid.innerHTML = '';
            const shop = shopData[shopId];
            Object.keys(shop.items).forEach(key => {
                const it = shop.items[key];
                const card = document.createElement('div');
                card.className = 'p-3 rounded-lg bg-white/80 border shadow text-center';
                card.innerHTML = `<div class="text-3xl mb-2">${it.icon||'🎁'}</div><div class="font-semibold">${it.name}</div><div class="text-sm text-gray-600">${it.desc||''}</div><div class="mt-2 font-bold">${it.price} Poin</div>`;
                const btn = document.createElement('button'); btn.className='mt-2 w-full bg-amber-500 hover:bg-amber-600 text-white py-2 rounded'; btn.textContent='Beli';
                btn.addEventListener('click', () => purchaseItem(shopId, key));
                card.appendChild(btn);
                grid.appendChild(card);
            });
        }

        function purchaseItem(shopId, itemId) {
            if (!activeUser) { showMascotTip('Pilih pengguna dulu.'); return; }
            const shop = shopData[shopId];
            const item = shop.items[itemId];
            if (!item) return;
            if ((activeUser.points || 0) >= item.price) {
                activeUser.points -= item.price;
                // special handling for avatars
                if (shopId === 'tokoAvatar') {
                    activeUser.unlockedAvatars = activeUser.unlockedAvatars || [];
                    if (!activeUser.unlockedAvatars.includes(itemId)) activeUser.unlockedAvatars.push(itemId);
                } else {
                    // add to inventory
                    activeUser.inventory = activeUser.inventory || {};
                    activeUser.inventory[itemId] = (activeUser.inventory[itemId] || 0) + 1;
                }
                saveData();
                playSound('purchase');
                showMascotTip(`${item.name} berhasil dibeli!`);
                try { updateMissionProgress(1, { purchased: true, shopId, itemId }); } catch(e) {}
                document.getElementById('generic-shop-balance').textContent = `Poin: ${activeUser.points}`;
                renderShopItems(shopId);
                renderDailyMission();
            } else { playSound('wrong'); showMascotTip('Poin tidak cukup.'); }
        }

        // Wire shop hub buttons
        document.querySelectorAll('.open-shop').forEach(el => {
            el.addEventListener('click', () => {
                const shopId = el.dataset.shop;
                openGenericShop(shopId);
            });
        });
        document.getElementById('generic-shop-close').addEventListener('click', hideModals);

        function createNewUser(name, avatarId, role) {
            const starterAvatars = Object.keys(avatarData).filter(id => avatarData[id].isStarter);
            const newUser = {
                id: Date.now(),
                name,
                avatarId,
                role,
                jenjang: 'sd',
                points: 0,
                progress: {},
                badges: {},
                dailyMission: {},
                lastLogin: null,
                loginStreak: 0,
                unlockedAvatars: starterAvatars,
                settings: { soundOn: true, musicOn: true, theme: 'light' },
            };
            initializeProgressForJenjang(newUser);
            userProfiles.push(newUser);
            currentUserIndex = userProfiles.length - 1;
            activeUser = newUser;
            saveData();
            startSession();
        }

        function initializeProgressForJenjang(user) {
            const jenjang = user.jenjang;
            if (!edukasiData[jenjang] || !user) return;
            if (!user.progress) user.progress = {};
            if (user.progress[jenjang]) return;
            user.progress[jenjang] = {};
            for (const duniaId in edukasiData[jenjang].dunia) {
                user.progress[jenjang][duniaId] = {};
                for (const submateriId in edukasiData[jenjang].dunia[duniaId].subMateri) {
                    user.progress[jenjang][duniaId][submateriId] = { done: false };
                }
            }
        }
        
        function checkDailyLogin() {
            if(!activeUser) return;
            const today = new Date().toDateString();
            if (activeUser.lastLogin === today) return;
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (activeUser.lastLogin === yesterday.toDateString()) {
                activeUser.loginStreak = (activeUser.loginStreak || 0) + 1;
            } else {
                activeUser.loginStreak = 1;
            }
            
            const baseBonus = 50;
            const streakBonus = activeUser.loginStreak * 10;
            const totalBonus = baseBonus + streakBonus;
            
            activeUser.lastLogin = today;
            addPoints(totalBonus);
            
            domElements.dailyBonusAmount.textContent = `${totalBonus} Poin`;
            domElements.dailyStreakBonusText.textContent = activeUser.loginStreak > 1 ? `Bonus beruntun ${activeUser.loginStreak} hari: +${streakBonus} poin!` : "Kembali besok untuk bonus lebih besar!";
            
            showModal('daily-bonus-modal');
            saveData();
            updateUI();
        }

        function updateUI() {
            if (!activeUser) return;
            applySettings();
            domElements.welcomeMessage.textContent = `Halo, ${activeUser.name}!`;
            domElements.userAvatarHeader.innerHTML = avatarData[activeUser.avatarId].svg;
            domElements.pointsDisplay.textContent = `💰 Poin: ${activeUser.points}`;
            domElements.streakDisplay.innerHTML = (activeUser.loginStreak || 0) > 1 ? `🔥 ${activeUser.loginStreak}` : '';

            if (activeUser.role === 'guru') {
                domElements.contentCreatorBtn.classList.remove('hidden');
            } else {
                domElements.contentCreatorBtn.classList.add('hidden');
            }
        }

        function addPoints(amount) {
            if (!activeUser) return;
            activeUser.points += amount;
            showAnimation(`+${amount}`, 'point');
            saveData();
            updateUI();
            // update daily mission if it's a points-collection mission
            try { updateMissionProgress(amount); } catch(e){}
            checkForBadges();
        }

        function handleQuizAnswer(element, answer, duniaId, submateriId) {
            const feedbackEl = domElements.materiContent.querySelector('#quiz-feedback');
            const userAnswer = element.textContent.trim();
            const isCorrect = userAnswer.toLowerCase() === answer.toLowerCase();

            if (isCorrect) {
                playSound('correct');
                feedbackEl.textContent = 'Jawaban Benar!';
                feedbackEl.className = 'mt-4 text-lg font-bold text-green-600';
                element.classList.add('quiz-correct');
                
                const isCompleted = activeUser.progress[activeUser.jenjang]?.[duniaId]?.[submateriId]?.done;
                if (!isCompleted) {
                    addPoints(10);
                    activeUser.progress[activeUser.jenjang][duniaId][submateriId] = { done: true };
                    updateMissionProgress(1); // Untuk misi selesaikan kuis
                    saveData();
                    checkForBadges();
                }
                
                setTimeout(() => {
                    const materi = edukasiData.sd.dunia[duniaId].subMateri[submateriId];
                    if (materi.funFact) {
                        domElements.mascotContainer.innerHTML = mascotSVG;
                        domElements.funFactText.textContent = materi.funFact;
                        showModal('fun-fact-modal');
                    } else {
                        renderSubMateri(duniaId);
                        switchScreen('submateri-screen');
                    }
                }, 1000);

            } else {
                playSound('wrong');
                feedbackEl.textContent = 'Coba lagi!';
                feedbackEl.className = 'mt-4 text-lg font-bold text-red-600';
                element.classList.add('quiz-wrong');
            }
            domElements.materiContent.querySelectorAll('button').forEach(btn => btn.disabled = true);
        }
        
        function renderDuniaMap() {
            const jenjang = activeUser.jenjang;
            const dataDunia = edukasiData[jenjang]?.dunia || {};
            domElements.duniaContainer.innerHTML = '';

            if (Object.keys(dataDunia).length === 0) {
                 domElements.duniaContainer.innerHTML = `<p class="col-span-full text-center text-white/80 text-lg">Belum ada materi. Guru dapat menambahkan materi.</p>`;
                 return;
            }

            for (const duniaId in dataDunia) {
                const dunia = dataDunia[duniaId];
                const c = colorMapping[dunia.warna] || colorMapping.blue;
                const progress = activeUser.progress[jenjang]?.[duniaId] || {};
                const total = Object.keys(dunia.subMateri).length;
                const completed = Object.values(progress).filter(p => p.done).length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                const card = document.createElement('div');
                card.className = `p-6 rounded-2xl shadow-lg cursor-pointer card-hover border-4 ${c.border} flex flex-col items-center text-center bg-white/90 backdrop-blur-sm`;
                card.innerHTML = `
                    <div class="w-20 h-20 flex items-center justify-center"><div class="text-5xl">${dunia.icon}</div></div>
                    <h3 class="font-brand text-2xl mt-2 ${c.text}">${dunia.namaDunia}</h3>
                    <p class="text-gray-600 text-sm mt-1 h-10">${dunia.deskripsi}</p>
                    <div class="mt-4 w-full">
                        <div class="text-sm font-semibold text-gray-700">${completed} / ${total} Selesai</div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                            <div class="${c.progress} h-2.5 rounded-full" style="width: ${percentage}%;"></div>
                        </div>
                    </div>`;
                card.addEventListener('click', () => {
                    playSound('click');
                    currentDuniaId = duniaId;
                    try { updateMissionProgress(0, { duniaId }); } catch(e) {}
                    renderSubMateri(duniaId);
                    switchScreen('submateri-screen');
                });
                domElements.duniaContainer.appendChild(card);
            }
            // apply search filter if present
            const search = document.getElementById('world-search-input');
            if (search && search.value.trim()) {
                const q = search.value.trim().toLowerCase();
                Array.from(domElements.duniaContainer.children).forEach(card => {
                    const title = card.querySelector('.font-brand')?.textContent?.toLowerCase() || '';
                    if (!title.includes(q)) card.style.display = 'none';
                });
            }
        }
        
        function renderSubMateri(duniaId) { 
            const dunia = edukasiData[activeUser.jenjang].dunia[duniaId];
            const colors = colorMapping[dunia.warna] || colorMapping.blue;
            domElements.submateriTitle.textContent = dunia.namaDunia;
            domElements.submateriTitle.className = `font-brand text-4xl md:text-5xl text-center text-white`;
            domElements.submateriContainer.innerHTML = '';
            
            if (Object.keys(dunia.subMateri).length === 0) {
                 domElements.submateriContainer.innerHTML = `<p class="col-span-full text-center text-white/80 text-lg">Belum ada submateri di dunia ini.</p>`;
                 return;
            }

            for (const submateriId in dunia.subMateri) {
                const submateri = dunia.subMateri[submateriId];
                const isCompleted = activeUser.progress[activeUser.jenjang]?.[duniaId]?.[submateriId]?.done;
                const card = document.createElement('div');
                card.className = `p-5 rounded-xl shadow-md flex items-center justify-between border-2 ${colors.border} cursor-pointer card-hover bg-white/90 backdrop-blur-sm`;
                card.innerHTML = `<span class="font-semibold ${colors.text}">${submateri.judul}</span> ${isCompleted ? `<span class="text-2xl text-yellow-500">⭐</span>` : `<span class="w-6 h-6 rounded-full border-2 ${colors.border}"></span>`}`; 
                card.addEventListener('click', () => { 
                    playSound('click'); 
                    currentSubmateriId = submateriId; 
                    renderMateri(duniaId, submateriId); 
                    switchScreen('materi-screen'); 
                });
                domElements.submateriContainer.appendChild(card);
            }
        }

        function renderMateri(duniaId, submateriId) { 
            const materi = edukasiData[activeUser.jenjang].dunia[duniaId].subMateri[submateriId];
            const quiz = materi.kuis[0];
            let optionsHTML = '';
            const shuffledPilihan = [...quiz.pilihan].sort(() => Math.random() - 0.5);
            if (quiz.type === 'pilihan-ganda') { 
                shuffledPilihan.forEach(o => { optionsHTML += `<button class="quiz-option w-full text-left p-4 my-2 border-2 rounded-lg font-semibold transition-colors hover:bg-gray-100">${o}</button>`; }); 
            }
            
            domElements.materiContent.innerHTML = `
                <h2 class="font-brand text-3xl mb-4">${materi.judul}</h2>
                <div class="prose max-w-none text-gray-800">${materi.konten}</div>
                <hr class="my-6">
                <h3 class="font-bold text-xl mb-3">Tantangan!</h3>
                <p class="mb-4 text-lg">${quiz.pertanyaan}</p>
                <div>${optionsHTML}</div>
                <div id="quiz-feedback" class="mt-4 text-lg font-bold"></div>`;

            domElements.materiContent.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', (e) => handleQuizAnswer(e.target, quiz.jawaban, duniaId, submateriId));
            });
        }
        
        function setupNewUserScreen() {
            domElements.avatarSelectionContainer.innerHTML = '';
            const starterAvatars = Object.keys(avatarData).filter(id => avatarData[id].isStarter);
            starterAvatars.forEach(avatarId => {
                const avatarEl = document.createElement('div');
                avatarEl.className = 'avatar-selection w-20 h-20 p-1 border-4 border-transparent rounded-full cursor-pointer transition-all';
                avatarEl.dataset.avatarId = avatarId;
                avatarEl.innerHTML = avatarData[avatarId].svg;
                avatarEl.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-selection').forEach(el => el.classList.remove('selected', 'border-orange-400', 'scale-110'));
                    avatarEl.classList.add('selected', 'border-orange-400', 'scale-110');
                    selectedAvatarId = avatarId;
                    domElements.createProfileBtn.disabled = !domElements.playerNameInput.value.trim();
                });
                domElements.avatarSelectionContainer.appendChild(avatarEl);
            });
        }
        
        function startSession() {
            checkDailyLogin();
            generateDailyMission();
            updateUI();
            switchScreen('map-screen');
            renderDuniaMap();
        }
        
        function renderUserSelectionScreen() {
            domElements.userListContainer.innerHTML = ''; 
            userProfiles.forEach((user, index) => {
                const card = document.createElement('div');
                card.className = 'user-card p-4 rounded-2xl shadow-lg text-center cursor-pointer card-hover bg-white/90 backdrop-blur-sm';
                card.innerHTML = `${(avatarData[user.avatarId] || avatarData.avatar1).svg}<h3 class="font-bold text-xl mt-2 text-gray-800">${user.name}</h3><p class="text-sm text-gray-500 capitalize">${user.role} - ${user.jenjang.toUpperCase()}</p>`;
                card.addEventListener('click', () => { 
                    playSound('click'); 
                    currentUserIndex = index; 
                    activeUser = userProfiles[index];
                    startSession();
                });
                domElements.userListContainer.appendChild(card);
            });
            switchScreen('user-selection-screen');
        }

        function checkRoleSelection() {
            const btn = document.getElementById('continue-to-profile-btn');
            btn.disabled = !tempUserData.role;
        }
        
        function populateDuniaSelect() {
            domElements.duniaSelect.innerHTML = '<option value="">-- Pilih Dunia --</option>';
            const duniaList = edukasiData.sd.dunia;
            for (const duniaId in duniaList) {
                const option = document.createElement('option');
                option.value = duniaId;
                option.textContent = duniaList[duniaId].namaDunia;
                domElements.duniaSelect.appendChild(option);
            }
        }

        // Import / Export & Reset helpers
        function exportData() {
            const payload = { users: userProfiles, edu: edukasiData };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'questoria-export.json'; a.click(); URL.revokeObjectURL(url);
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (parsed.users) userProfiles = parsed.users;
                    if (parsed.edu) edukasiData = parsed.edu;
                    saveData();
                    showMascotTip('Data berhasil diimpor.');
                    renderDuniaMap();
                } catch (err) { alert('File tidak valid.'); }
            };
            reader.readAsText(file);
        }

        function resetAllAchievements() {
            userProfiles.forEach(u => { u.badges = {}; });
            saveData();
            showMascotTip('Semua prestasi direset.');
        }
        
        function showAnimation(text, type = 'point') {
            const animEl = document.createElement('div');
            animEl.className = 'point-animation';
            animEl.textContent = text;
            domElements.animationContainer.appendChild(animEl);
            setTimeout(() => animEl.remove(), 1500);
        }

        function showMascotTip(message) { 
            domElements.mascotTipContainer.innerHTML = ''; 
            const tipEl = document.createElement('div'); 
            tipEl.className = 'mascot-tip'; 
            tipEl.innerHTML = `<div class="w-12 h-12 mr-3">${mascotSVG}</div><p class="text-sm">${message}</p>`; 
            domElements.mascotTipContainer.appendChild(tipEl); 
            setTimeout(() => { tipEl.remove(); }, 4000); 
        }

        function spawnConfetti(count = 20) {
            const colors = ['#f97316','#f59e0b','#34d399','#60a5fa','#a78bfa','#fb7185'];
            for (let i=0;i<count;i++){
                const el = document.createElement('div'); el.className='confetti-piece';
                el.style.background = colors[Math.floor(Math.random()*colors.length)];
                el.style.left = (Math.random()*100)+'vw'; el.style.top = (Math.random()*-20)+'vh';
                el.style.transform = `rotate(${Math.random()*360}deg)`;
                document.body.appendChild(el);
                setTimeout(()=> el.remove(), 2000);
            }
        }

        function checkForBadges() {
            if (!activeUser) return;
            const defs = achievementsDefinitions.sd;
            activeUser.badges = activeUser.badges || {};
            defs.forEach(def => {
                if (!(activeUser.badges[def.id]) && def.condition(activeUser)) {
                    activeUser.badges[def.id] = true;
                    playSound('badge');
                    showMascotTip(`Prestasi Terbuka: ${def.title}`);
                    spawnConfetti(30);
                    saveData();
                }
            });
        }
        
        function renderAchievements() {
            domElements.achievementsList.innerHTML = '';
            const defs = achievementsDefinitions.sd;
            defs.forEach(def => {
                const unlocked = activeUser.badges && activeUser.badges[def.id];
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg flex items-center gap-4 ${unlocked ? 'bg-green-100' : 'bg-gray-100 opacity-70'}`;
                card.innerHTML = `
                    <div class="text-3xl">${unlocked ? '🏆' : '🔒'}</div>
                    <div>
                        <h4 class="font-bold">${def.title}</h4>
                        <p class="text-sm">${def.desc}</p>
                    </div>
                `;
                domElements.achievementsList.appendChild(card);
            });
        }
        
        function renderLeaderboard() {
            domElements.leaderboardList.innerHTML = '';
            const sortedUsers = [...userProfiles].sort((a, b) => b.points - a.points);
            sortedUsers.forEach((user, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
                const isCurrentUser = user.id === activeUser.id;
                const row = document.createElement('div');
                row.className = `flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-blue-100 border-2 border-blue-400' : ''}`
                row.innerHTML = `<div class="flex items-center gap-3"><span class="font-bold text-lg w-8 text-center">${medal}</span><span class="font-semibold">${user.name}</span></div><span class="font-bold text-amber-600">${user.points} Poin</span>`;
                domElements.leaderboardList.appendChild(row);
            });
        }
        
        function generateDailyMission() {
            if (!activeUser) return;
            // If mission exists and not claimed, keep it for the day
            if (activeUser.dailyMission && !activeUser.dailyMission.claimed) return;

            const templates = [
                { type: 'kuis', text: 'Selesaikan 2 kuis', goal: 2, reward: 30 },
                { type: 'kuis', text: 'Selesaikan 5 kuis', goal: 5, reward: 75 },
                { type: 'points', text: 'Kumpulkan 100 poin', goal: 100, reward: 50 },
                { type: 'visit', text: 'Kunjungi 3 dunia berbeda', goal: 3, reward: 40 },
                { type: 'shop', text: 'Beli 1 item di toko', goal: 1, reward: 60 },
            ];

            const choice = templates[Math.floor(Math.random() * templates.length)];
            activeUser.dailyMission = { ...choice, progress: 0, claimed: false, createdAt: new Date().toDateString() };
            saveData();
        }

        function renderDailyMission() {
            const m = activeUser.dailyMission;
            if (!m) {
                domElements.dailyMissionText.textContent = '';
                domElements.missionProgressBar.style.width = '0%';
                domElements.missionProgressBar.textContent = `0%`;
                domElements.claimMissionRewardBtn.disabled = true;
                return;
            }
            // Validate mission fields; if missing, regenerate
            if (typeof m.text === 'undefined' || typeof m.goal === 'undefined') {
                console.warn('Invalid dailyMission structure, regenerating');
                generateDailyMission();
                return renderDailyMission();
            }
            domElements.dailyMissionText.textContent = `${m.text} (${m.progress}/${m.goal})`;
            const pct = Math.min(100, (m.progress / m.goal) * 100);
            domElements.missionProgressBar.style.width = `${pct}%`;
            domElements.missionProgressBar.textContent = `${Math.round(pct)}%`;
            domElements.claimMissionRewardBtn.disabled = !(m.progress >= m.goal && !m.claimed);
        }

        function updateMissionProgress(amount, meta) {
            const m = activeUser.dailyMission;
            if (!m || m.claimed) return;

            // Support different mission types
            if (m.type === 'kuis') {
                m.progress = (m.progress || 0) + amount;
            } else if (m.type === 'points') {
                // amount is points gained
                m.progress = (m.progress || 0) + amount;
            } else if (m.type === 'visit') {
                // meta should carry duniaId to count unique visits
                m._visited = m._visited || new Set();
                if (meta && meta.duniaId) m._visited.add(meta.duniaId);
                m.progress = m._visited.size;
            } else if (m.type === 'shop') {
                // meta can indicate a purchase
                if (meta && meta.purchased) m.progress = (m.progress || 0) + 1;
            }

            if (m.progress >= m.goal) {
                m.progress = m.goal;
                showMascotTip('Misi harian selesai! Klaim hadiahnya.');
                spawnConfetti(20);
            }

            saveData();
            renderDailyMission();
        }

        function applySettings() {
            document.body.classList.remove('dark', 'high-contrast');
            const theme = activeUser?.settings?.theme || 'light';
            if (theme === 'dark') document.body.classList.add('dark');
            else if (theme === 'high-contrast') document.body.classList.add('high-contrast');
            
            domElements.soundToggle.textContent = activeUser?.settings?.soundOn ? '🔊' : '🔈';
            domElements.musicToggle.textContent = activeUser?.settings?.musicOn ? '🎵' : '🎶';
        }

        // --- Inisialisasi & Event Listeners ---
        function initializeApp() {
            setTimeout(() => {
                domElements.splashScreen.style.opacity = '0';
                setTimeout(() => {
                    domElements.splashScreen.style.display = 'none';
                    loadData(); // Memuat data
                    
                    // Menambahkan maskot ke layar mulai
                    const startScreenMascotContainer = document.getElementById('start-screen-mascot');
                    if(startScreenMascotContainer) {
                        startScreenMascotContainer.innerHTML = mascotSVG;
                    }
                    
                    // [MODIFIKASI] Menampilkan layar mulai yang baru terlebih dahulu
                    switchScreen('start-screen'); 

                }, 700);
            }, 4000);
        }

        // Safe Tone start: resume on user gesture if needed
        document.addEventListener('click', ()=>{
            try { if (Tone && Tone.context && Tone.context.state !== 'running') Tone.start(); } catch(e){}
        }, { once: true });

        // [BARU] Listener untuk tombol Mulai yang baru
        document.getElementById('start-game-btn').addEventListener('click', () => {
            playSound('click');
            if (window.startBackgroundMusic) {
                window.startBackgroundMusic();
            }
            
            const startScreen = document.getElementById('start-screen');
            startScreen.classList.add('fade-out');

            setTimeout(() => {
                // Cek jika ada profil pengguna atau tidak
                if (userProfiles.length > 0) {
                    switchScreen('entry-screen'); // Tampilkan pilihan login/register seperti di foto
                } else {
                    // Langsung ke layar pendaftaran jika belum ada pengguna
                    showMascotTip("Selamat datang! Yuk, buat akun barumu dulu.");
                    switchScreen('role-screen');
                }
                startScreen.classList.remove('fade-out'); // Reset class untuk nanti
            }, 500); // Sesuaikan dengan durasi animasi fadeOut
        });


        // Alur Masuk & Pendaftaran
        domElements.loginBtn.addEventListener('click', () => {
            playSound('click');
            if(userProfiles.length > 0) { renderUserSelectionScreen(); } 
            else { showMascotTip("Belum ada akun terdaftar. Silakan buat akun baru."); }
        });
        domElements.registerBtn.addEventListener('click', () => { playSound('click'); switchScreen('role-screen'); });
        document.getElementById('back-to-entry-btn').addEventListener('click', () => { playSound('click'); switchScreen('entry-screen'); });
        document.getElementById('back-from-selection-btn').addEventListener('click', () => { playSound('click'); switchScreen('entry-screen'); });
        document.getElementById('role-selection').addEventListener('click', (e) => {
            const target = e.target.closest('.role-option');
            if (target) {
                playSound('click');
                document.querySelectorAll('.role-option').forEach(el => el.classList.remove('selected'));
                target.classList.add('selected');
                tempUserData.role = target.dataset.role;
                checkRoleSelection();
            }
        });
        document.getElementById('continue-to-profile-btn').addEventListener('click', () => { playSound('click'); setupNewUserScreen(); switchScreen('name-entry-screen'); });
        domElements.cancelNewUserBtn.addEventListener('click', () => { playSound('click'); switchScreen('role-screen'); });
        domElements.createProfileBtn.addEventListener('click', () => { createNewUser(domElements.playerNameInput.value.trim(), selectedAvatarId, tempUserData.role); });
        domElements.playerNameInput.addEventListener('input', () => { domElements.createProfileBtn.disabled = !(domElements.playerNameInput.value.trim() && selectedAvatarId); });

        // Navigasi Dalam Aplikasi
        domElements.settingsBtn.addEventListener('click', () => { showModal('settings-modal'); });
        domElements.closeSettingsBtn.addEventListener('click', hideModals);
        domElements.changeUserBtn.addEventListener('click', () => { hideModals(); activeUser = null; currentUserIndex = -1; switchScreen('entry-screen'); });
        domElements.resetProgressBtn.addEventListener('click', () => { document.getElementById('reset-username-confirm').textContent = activeUser.name; showModal('confirm-reset-modal'); });
        domElements.cancelResetBtn.addEventListener('click', () => { hideModals(); showModal('settings-modal'); });
        domElements.confirmResetBtn.addEventListener('click', () => { activeUser.progress.sd = {}; activeUser.points = 0; saveData(); hideModals(); updateUI(); renderDuniaMap(); });
        domElements.backToWorldsBtn.addEventListener('click', () => { renderDuniaMap(); switchScreen('map-screen'); });
        domElements.backToSubmateriBtn.addEventListener('click', () => { renderSubMateri(currentDuniaId); switchScreen('submateri-screen'); });
        domElements.closeFunFactBtn.addEventListener('click', () => { hideModals(); renderSubMateri(currentDuniaId); switchScreen('submateri-screen'); });
        
        // Tombol Header
        domElements.shopHubBtn.addEventListener('click', () => { showModal('shop-hub-modal'); });
        document.getElementById('close-shop-hub-btn').addEventListener('click', hideModals);
        document.querySelector('[data-shop="tokoAvatar"]')?.addEventListener('click', () => {
             if (!activeUser) { showMascotTip('Pilih pengguna terlebih dahulu.'); return; }
             domElements.shopPointsDisplay.textContent = `${activeUser.points} Poin`;
             domElements.avatarShopContainer.innerHTML = '';
             Object.keys(avatarData).forEach(id => {
                if(avatarData[id].isStarter) return;
                const item = avatarData[id];
                const owned = (activeUser.unlockedAvatars || []).includes(id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl text-center cursor-pointer border-2 ${owned ? 'border-green-500' : 'border-gray-200'}`;
                div.innerHTML = `<div class='mb-2'>${item.svg || item.icon || '👤'}</div><div class='font-semibold'>${item.name || id}</div><div class='text-sm text-gray-500'>${owned ? 'Dimiliki' : `${item.price || 0} Poin`}</div>`;
                if (!owned && item.price) {
                    div.addEventListener('click', () => {
                        if (activeUser.points >= item.price) {
                            activeUser.points -= item.price;
                            activeUser.unlockedAvatars = activeUser.unlockedAvatars || [];
                            activeUser.unlockedAvatars.push(id);
                            saveData();
                            playSound('purchase');
                            showMascotTip(`${item.name || id} berhasil dibeli!`);
                            // refresh
                            document.querySelector('[data-shop="tokoAvatar"]')?.click();
                        } else {
                            playSound('wrong');
                            showMascotTip('Poin tidak cukup.');
                        }
                    });
                }
                domElements.avatarShopContainer.appendChild(div);
             });
             hideModals(); showModal('avatar-shop-modal');
        });
        domElements.closeAvatarShopBtn.addEventListener('click', hideModals);
        
        domElements.dailyMissionBtn.addEventListener('click', () => { renderDailyMission(); showModal('daily-mission-modal'); });
        document.getElementById('claim-mission-reward-btn').addEventListener('click', () => {
             const m = activeUser.dailyMission;
             if (m && m.progress >= m.goal && !m.claimed) {
                addPoints(m.reward);
                m.claimed = true;
                saveData();
                showMascotTip(`Misi Selesai! +${m.reward} Poin`);
                renderDailyMission();
             }
        });
        document.getElementById('close-daily-mission-btn').addEventListener('click', hideModals);
        document.getElementById('close-daily-bonus-btn').addEventListener('click', hideModals);

        domElements.leaderboardBtn.addEventListener('click', () => { renderLeaderboard(); showModal('leaderboard-modal'); });
        document.getElementById('close-leaderboard-btn').addEventListener('click', hideModals);

        domElements.achievementsBtn.addEventListener('click', () => { renderAchievements(); showModal('achievements-modal'); });
        document.getElementById('close-achievements-btn').addEventListener('click', hideModals);

        // Pengaturan
        domElements.soundToggle.addEventListener('click', () => { activeUser.settings.soundOn = !activeUser.settings.soundOn; saveData(); applySettings(); });
        domElements.musicToggle.addEventListener('click', () => { activeUser.settings.musicOn = !activeUser.settings.musicOn; saveData(); applySettings(); });
        domElements.themeSelector.addEventListener('click', (e) => {
            if(e.target.dataset.theme) {
                activeUser.settings.theme = e.target.dataset.theme;
                saveData();
                applySettings();
            }
        });

        // Fitur Guru
        domElements.contentCreatorBtn.addEventListener('click', () => { populateDuniaSelect(); showModal('content-creator-modal'); });
        domElements.closeCreatorBtn.addEventListener('click', hideModals);
        // Content creator enhancements: add/remove quiz choices, preview, and edit existing
        const creatorForm = document.getElementById('content-creator-form');
    const kuisContainer = document.createElement('div'); kuisContainer.id='kuis-multi-container';
    // augment form UI (non-destructive)
    const kuisSection = creatorForm.querySelectorAll('div.p-4')[2];
    if (kuisSection && !kuisSection.querySelector('#kuis-multi-container')) kuisSection.appendChild(kuisContainer);

        function buildKuisControls() {
            kuisContainer.innerHTML = '';
            const template = document.createElement('div');
            template.className = 'space-y-2 kuis-block p-2 border rounded bg-white';
            template.innerHTML = `
                <textarea class="kuis-pertanyaan w-full p-2 border rounded" rows="2" placeholder="Pertanyaan kuis"></textarea>
                <div class="kuis-choices space-y-1"></div>
                <div class="flex gap-2 mt-2">
                    <button type="button" class="add-choice bg-blue-500 text-white px-3 py-1 rounded">Tambah Pilihan</button>
                    <button type="button" class="remove-kuis bg-red-500 text-white px-3 py-1 rounded">Hapus Kuis</button>
                    <button type="button" class="preview-kuis bg-green-500 text-white px-3 py-1 rounded">Pratinjau</button>
                </div>`;
            // start with one block
            const block = template.cloneNode(true);
            kuisContainer.appendChild(block);
            addChoiceListeners(block);
        }

        function addChoiceListeners(block) {
            const choicesWrap = block.querySelector('.kuis-choices');
            function addChoice(value='', correct=false) {
                const el = document.createElement('div'); el.className='flex gap-2 items-center';
                el.innerHTML = `<input class="choice-text flex-1 p-2 border rounded" value="${value}" placeholder="Pilihan..."/><label class="flex items-center gap-1"><input type="radio" name="correct-${Date.now()}" class="choice-correct" ${correct? 'checked':''}/> Benar</label>`;
                const remove = document.createElement('button'); remove.type='button'; remove.className='ml-2 text-sm text-red-600'; remove.textContent='✖'; remove.addEventListener('click', ()=> el.remove());
                el.appendChild(remove);
                choicesWrap.appendChild(el);
            }
            block.querySelector('.add-choice').addEventListener('click', ()=> addChoice());
            block.querySelector('.remove-kuis').addEventListener('click', ()=> block.remove());
            block.querySelector('.preview-kuis').addEventListener('click', ()=> {
                const q = block.querySelector('.kuis-pertanyaan').value.trim();
                const choices = Array.from(block.querySelectorAll('.choice-text')).map(i=>i.value).filter(v=>v.trim());
                if (!q || choices.length===0) { alert('Pertanyaan atau pilihan belum lengkap'); return; }
                // quick preview modal
                domElements.materiContent.innerHTML = `<h3 class="font-bold">Preview: ${q}</h3>` + choices.map(c=>`<div class="p-2 m-1 border rounded">${c}</div>`).join('');
                switchScreen('materi-screen');
            });
            // add two default choices
            addChoice(); addChoice();
        }

        buildKuisControls();
        // Autosave draft: store form state periodically
        const DRAFT_KEY = 'questoria_creator_draft_v1';
        function saveCreatorDraft() {
            try {
                const draft = {
                    duniaSelect: domElements.duniaSelect.value,
                    duniaNama: document.getElementById('dunia-nama')?.value,
                    duniaDesc: document.getElementById('dunia-deskripsi')?.value,
                    duniaWarna: document.getElementById('dunia-warna')?.value,
                    duniaIcon: document.getElementById('dunia-icon')?.value,
                    judul: document.getElementById('submateri-judul')?.value,
                    konten: document.getElementById('submateri-konten')?.value,
                    funFact: document.getElementById('submateri-funfact')?.value,
                    kuisBlocks: Array.from(kuisContainer.querySelectorAll('.kuis-block')).map(b => ({ q: b.querySelector('.kuis-pertanyaan').value, choices: Array.from(b.querySelectorAll('.choice-text')).map(i=>i.value), correctIndex: Array.from(b.querySelectorAll('.choice-correct')).findIndex(ch=>ch.checked) }))
                };
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
            } catch(e){}
        }

        function loadCreatorDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY); if (!raw) return;
                const draft = JSON.parse(raw);
                if (draft.duniaSelect) domElements.duniaSelect.value = draft.duniaSelect;
                if (draft.duniaNama) document.getElementById('dunia-nama').value = draft.duniaNama;
                if (draft.judul) document.getElementById('submateri-judul').value = draft.judul;
                if (draft.konten) document.getElementById('submateri-konten').value = draft.konten;
                // rebuild kuis blocks
                if (draft.kuisBlocks && draft.kuisBlocks.length) {
                    kuisContainer.innerHTML = '';
                    draft.kuisBlocks.forEach(block => {
                        const template = document.createElement('div'); template.className='space-y-2 kuis-block p-2 border rounded bg-white';
                        template.innerHTML = `\n                <textarea class="kuis-pertanyaan w-full p-2 border rounded" rows="2" placeholder="Pertanyaan kuis">${(block.q||'')}</textarea>\n                <div class="kuis-choices space-y-1"></div>\n                <div class="flex gap-2 mt-2">\n                    <button type="button" class="add-choice bg-blue-500 text-white px-3 py-1 rounded">Tambah Pilihan</button>\n                    <button type="button" class="remove-kuis bg-red-500 text-white px-3 py-1 rounded">Hapus Kuis</button>\n                    <button type="button" class="preview-kuis bg-green-500 text-white px-3 py-1 rounded">Pratinjau</button>\n                </div>`;
                        kuisContainer.appendChild(template);
                        const choicesWrap = template.querySelector('.kuis-choices');
                        (block.choices||[]).forEach((c,i)=>{
                            const el = document.createElement('div'); el.className='flex gap-2 items-center';
                            el.innerHTML = `<input class="choice-text flex-1 p-2 border rounded" value="${c||''}" placeholder="Pilihan..."/><label class="flex items-center gap-1"><input type="radio" name="correct-${Date.now()}-${Math.random()}" class="choice-correct" ${i===block.correctIndex? 'checked':''}/> Benar</label>`;
                            const remove = document.createElement('button'); remove.type='button'; remove.className='ml-2 text-sm text-red-600'; remove.textContent='✖'; remove.addEventListener('click', ()=> el.remove());
                            el.appendChild(remove); choicesWrap.appendChild(el);
                        });
                        addChoiceListeners(template);
                    });
                }
            } catch(e){}
        }

        setInterval(saveCreatorDraft, 3000);
        loadCreatorDraft();
        creatorForm.addEventListener('submit', (e) => {
            e.preventDefault();
            try {
                let duniaId = domElements.duniaSelect.value;
                const namaDuniaBaru = document.getElementById('dunia-nama').value.trim();

                if (namaDuniaBaru) {
                    duniaId = `dunia_custom_${Date.now()}`;
                    edukasiData.sd.dunia[duniaId] = {
                        namaDunia: namaDuniaBaru,
                        deskripsi: document.getElementById('dunia-deskripsi').value,
                        warna: document.getElementById('dunia-warna').value || 'blue',
                        icon: document.getElementById('dunia-icon').value || '⭐',
                        subMateri: {},
                    };
                }

                if (!duniaId) { alert("Pilih dunia atau buat yang baru."); return; }

                // determine if editing existing submateri
                const editingMeta = creatorForm.dataset.editing ? JSON.parse(creatorForm.dataset.editing) : null;

                const targetSubId = editingMeta ? editingMeta.subId : `submateri_custom_${Date.now()}`;

                // gather multi-kuis data from kuisContainer
                const kuisBlocks = Array.from(kuisContainer.querySelectorAll('.kuis-block'));
                const kuisList = kuisBlocks.map(b => {
                    const q = b.querySelector('.kuis-pertanyaan').value.trim();
                    const choices = Array.from(b.querySelectorAll('.choice-text')).map(i=>i.value).filter(v=>v.trim());
                    const correct = Array.from(b.querySelectorAll('.choice-correct')).findIndex(el=>el.checked);
                    return { type: 'pilihan-ganda', pertanyaan: q, pilihan: choices, jawaban: choices[correct]||choices[0]||'', hint: '' };
                }).filter(k=>k.pertanyaan && k.pilihan && k.pilihan.length>0);

                if (kuisList.length === 0) {
                    alert('Tambahkan setidaknya 1 kuis lengkap.');
                    return;
                }

                // If editing and dunia changed, we must move the submateri
                if (editingMeta) {
                    const { duniaId: oldDuniaId, subId: oldSubId } = editingMeta;
                    // update content
                    if (!edukasiData.sd.dunia[duniaId]) edukasiData.sd.dunia[duniaId] = { namaDunia: 'Dunia Baru', deskripsi: '', warna: 'blue', icon: '⭐', subMateri: {} };
                    // If moving to a different dunia
                    if (oldDuniaId !== duniaId) {
                        // copy to new dunia and delete old
                        edukasiData.sd.dunia[duniaId].subMateri[targetSubId] = {
                            judul: document.getElementById('submateri-judul').value,
                            konten: document.getElementById('submateri-konten').value,
                            funFact: document.getElementById('submateri-funfact').value,
                            kuis: kuisList
                        };
                        delete edukasiData.sd.dunia[oldDuniaId].subMateri[oldSubId];
                        // move user progress
                        userProfiles.forEach(u => {
                            if (u.progress && u.progress.sd) {
                                u.progress.sd[duniaId] = u.progress.sd[duniaId] || {};
                                u.progress.sd[duniaId][targetSubId] = u.progress.sd[oldDuniaId] && u.progress.sd[oldDuniaId][oldSubId] ? u.progress.sd[oldDuniaId][oldSubId] : { done: false };
                                if (u.progress.sd[oldDuniaId]) delete u.progress.sd[oldDuniaId][oldSubId];
                            }
                        });
                    } else {
                        // same dunia, overwrite
                        edukasiData.sd.dunia[duniaId].subMateri[oldSubId] = {
                            judul: document.getElementById('submateri-judul').value,
                            konten: document.getElementById('submateri-konten').value,
                            funFact: document.getElementById('submateri-funfact').value,
                            kuis: kuisList
                        };
                    }
                    // clear editing metadata
                    delete creatorForm.dataset.editing;
                } else {
                    // create new submateri
                    if (!edukasiData.sd.dunia[duniaId]) edukasiData.sd.dunia[duniaId] = { namaDunia: 'Dunia Baru', deskripsi: '', warna: 'blue', icon: '⭐', subMateri: {} };
                    edukasiData.sd.dunia[duniaId].subMateri[targetSubId] = {
                        judul: document.getElementById('submateri-judul').value,
                        konten: document.getElementById('submateri-konten').value,
                        funFact: document.getElementById('submateri-funfact').value,
                        kuis: kuisList
                    };
                    // add to users progress
                    userProfiles.forEach(user => {
                        if (user.jenjang === 'sd' && user.progress.sd) {
                            if (!user.progress.sd[duniaId]) { user.progress.sd[duniaId] = {}; }
                            user.progress.sd[duniaId][targetSubId] = { done: false };
                        }
                    });
                }

                saveData();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = "Materi berhasil disimpan!";
                // clear draft
                localStorage.removeItem(DRAFT_KEY);
                setTimeout(() => {
                    e.target.reset(); hideModals(); renderDuniaMap(); populateExistingSubmateri();
                    submitBtn.textContent = "Simpan Materi";
                }, 1200);
            } catch (error) { console.error("Error:", error); alert("Gagal menyimpan materi."); }
        });

        // Keyboard shortcuts & utility bindings
        window.addEventListener('keydown', (e)=>{
            if (e.key === 's' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); exportData(); }
            if (e.key === 'f' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); document.getElementById('world-search-input').classList.toggle('hidden'); document.getElementById('world-search-input').focus(); }
            if (e.key === 'k' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); openGenericShop('tokoPeningkatan'); }
        });

    // wire shop hub open (safe)
    document.querySelector('[data-shop="tokoAvatar"]')?.addEventListener('click', () => openGenericShop('tokoAvatar'));

        // search input binding
        const worldSearch = document.getElementById('world-search-input');
        if (worldSearch) {
            worldSearch.addEventListener('input', ()=> renderDuniaMap());
            worldSearch.classList.add('hidden');
        }

        // import/export/reset DOM controls (in settings modal)
        const importBtn = document.createElement('button'); importBtn.textContent='Impor Data'; importBtn.className='w-full p-2 mt-2 bg-white rounded';
        const exportBtn = document.createElement('button'); exportBtn.textContent='Ekspor Data'; exportBtn.className='w-full p-2 mt-2 bg-white rounded';
        const resetAchBtn = document.createElement('button'); resetAchBtn.textContent='Reset Prestasi'; resetAchBtn.className='w-full p-2 mt-2 bg-white rounded';
        const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='application/json'; fileInput.className='hidden';
        exportBtn.addEventListener('click', exportData);
        importBtn.addEventListener('click', ()=> fileInput.click());
        fileInput.addEventListener('change', (e)=> importData(e.target.files[0]));
        resetAchBtn.addEventListener('click', ()=> { if(confirm('Reset semua prestasi?')) resetAllAchievements(); });
        domElements.themeSelector.parentElement.appendChild(importBtn);
        domElements.themeSelector.parentElement.appendChild(exportBtn);
        domElements.themeSelector.parentElement.appendChild(resetAchBtn);
        domElements.themeSelector.parentElement.appendChild(fileInput);
        // Advanced import: merge another project's data (edu + shops)
        importBtn.addEventListener('click', ()=> fileInput.click());
        function importData(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const parsed = JSON.parse(ev.target.result);
                    // merge users (optional)
                    if (parsed.edu) {
                        // merge jenjang (sd) dunia/subMateri
                        for (const jenjang in parsed.edu) {
                            edukasiData[jenjang] = edukasiData[jenjang] || { dunia: {} };
                            const srcDunia = parsed.edu[jenjang].dunia || {};
                            for (const dId in srcDunia) {
                                if (!edukasiData[jenjang].dunia[dId]) edukasiData[jenjang].dunia[dId] = srcDunia[dId];
                                else {
                                    // merge subMateri
                                    const srcSub = srcDunia[dId].subMateri || {};
                                    edukasiData[jenjang].dunia[dId].subMateri = edukasiData[jenjang].dunia[dId].subMateri || {};
                                    for (const sId in srcSub) {
                                        if (!edukasiData[jenjang].dunia[dId].subMateri[sId]) edukasiData[jenjang].dunia[dId].subMateri[sId] = srcSub[sId];
                                    }
                                }
                            }
                        }
                        showMascotTip('Konten edukasi berhasil digabungkan.');
                    }
                    // merge shops
                    if (parsed.shopData) {
                        for (const k in parsed.shopData) {
                            shopData[k] = shopData[k] || parsed.shopData[k];
                            // copy items if missing
                            const items = parsed.shopData[k].items || {};
                            shopData[k].items = shopData[k].items || {};
                            for (const id in items) if (!shopData[k].items[id]) shopData[k].items[id] = items[id];
                        }
                        showMascotTip('Data toko berhasil digabungkan.');
                    }
                    saveData(); renderDuniaMap();
                } catch (err) { alert('File tidak valid atau format tidak dikenali.'); }
            };
            reader.readAsText(file);
        }
        
        // Populate existing submateri list in creator modal
        function populateExistingSubmateri() {
            const list = document.getElementById('existing-list'); if (!list) return;
            list.innerHTML = '';
            const duniaList = edukasiData.sd.dunia || {};
            for (const duniaId in duniaList) {
                const dunia = duniaList[duniaId];
                for (const subId in dunia.subMateri) {
                    const sub = dunia.subMateri[subId];
                    const row = document.createElement('div');
                    row.className = 'p-2 bg-white rounded flex items-center justify-between border';
                    row.innerHTML = `<div><div class="font-semibold">${sub.judul}</div><div class="text-xs text-gray-500">${dunia.namaDunia}</div></div>`;
                    const actions = document.createElement('div');
                    const editBtn = document.createElement('button'); editBtn.className='px-3 py-1 bg-blue-500 text-white rounded mr-2'; editBtn.textContent='Edit';
                    const delBtn = document.createElement('button'); delBtn.className='px-3 py-1 bg-red-500 text-white rounded'; delBtn.textContent='Hapus';
                    actions.appendChild(editBtn); actions.appendChild(delBtn); row.appendChild(actions);
                    editBtn.addEventListener('click', ()=> loadSubmateriForEdit(duniaId, subId));
                    delBtn.addEventListener('click', ()=> {
                        if (!confirm('Hapus submateri ini? Tindakan ini akan menghapusnya dari semua pengguna.')) return;
                        delete edukasiData.sd.dunia[duniaId].subMateri[subId];
                        // remove progress entry from users
                        userProfiles.forEach(u => {
                            if (u.progress && u.progress.sd && u.progress.sd[duniaId]) { delete u.progress.sd[duniaId][subId]; }
                        });
                        saveData(); populateExistingSubmateri(); renderDuniaMap(); showMascotTip('Submateri dihapus.');
                    });
                    list.appendChild(row);
                }
            }
        }

        function loadSubmateriForEdit(duniaId, subId) {
            const dunia = edukasiData.sd.dunia[duniaId];
            const sub = dunia.subMateri[subId];
            // ensure dunia select includes this dunia
            populateDuniaSelect();
            domElements.duniaSelect.value = duniaId;
            document.getElementById('submateri-judul').value = sub.judul || '';
            document.getElementById('submateri-konten').value = sub.konten || '';
            document.getElementById('submateri-funfact').value = sub.funFact || '';
            // clear kuisContainer and fill with existing kuis
            kuisContainer.innerHTML = '';
            (sub.kuis||[]).forEach(q => {
                const template = document.createElement('div'); template.className='space-y-2 kuis-block p-2 border rounded bg-white';
                template.innerHTML = `\n                <textarea class="kuis-pertanyaan w-full p-2 border rounded" rows="2" placeholder="Pertanyaan kuis">${q.pertanyaan||''}</textarea>\n                <div class="kuis-choices space-y-1"></div>\n                <div class="flex gap-2 mt-2">\n                    <button type="button" class="add-choice bg-blue-500 text-white px-3 py-1 rounded">Tambah Pilihan</button>\n                    <button type="button" class="remove-kuis bg-red-500 text-white px-3 py-1 rounded">Hapus Kuis</button>\n                    <button type="button" class="preview-kuis bg-green-500 text-white px-3 py-1 rounded">Pratinjau</button>\n                </div>`;
                kuisContainer.appendChild(template);
                const choicesWrap = template.querySelector('.kuis-choices');
                (q.pilihan||[]).forEach((c,i)=>{
                    const el = document.createElement('div'); el.className='flex gap-2 items-center';
                    el.innerHTML = `<input class="choice-text flex-1 p-2 border rounded" value="${c||''}" placeholder="Pilihan..."/><label class="flex items-center gap-1"><input type="radio" name="correct-${Date.now()}" class="choice-correct" ${q.jawaban===c? 'checked':''}/> Benar</label>`;
                    const remove = document.createElement('button'); remove.type='button'; remove.className='ml-2 text-sm text-red-600'; remove.textContent='✖'; remove.addEventListener('click', ()=> el.remove());
                    el.appendChild(remove); choicesWrap.appendChild(el);
                });
                addChoiceListeners(template);
            });
            // mark form with editing meta
            creatorForm.dataset.editing = JSON.stringify({ duniaId, subId });
            showMascotTip('Submateri dimuat untuk diedit.');
            // scroll to form top
            document.querySelector('#content-creator-modal .modal-content')?.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ensure existing list updates when modal opened
        document.querySelector('#content-creator-modal')?.addEventListener('click', ()=> populateExistingSubmateri());
        
        initializeApp();
    </script>
</body>
</html>
